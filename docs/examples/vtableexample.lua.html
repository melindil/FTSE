<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>FTSE Documentation</title>
    <link rel="stylesheet" href="../ldoc_fixed.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>FTSE</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Examples</h2>
<ul class="nowrap">
  <li><a href="../examples/armorattachedweapon.lua.html">armorattachedweapon.lua</a></li>
  <li><a href="../examples/hulksmash.lua.html">hulksmash.lua</a></li>
  <li><a href="../examples/missionvariables.lua.html">missionvariables.lua</a></li>
  <li><a href="../examples/nightperson.lua.html">nightperson.lua</a></li>
  <li><strong>vtableexample.lua</strong></li>
</ul>
<h2>Entity classes</h2>
<ul class="nowrap">
  <li><a href="../entity classes/Actor.html">Actor</a></li>
  <li><a href="../entity classes/Alarm.html">Alarm</a></li>
  <li><a href="../entity classes/Ammo.html">Ammo</a></li>
  <li><a href="../entity classes/Armour.html">Armour</a></li>
  <li><a href="../entity classes/BaseAI.html">BaseAI</a></li>
  <li><a href="../entity classes/Book.html">Book</a></li>
  <li><a href="../entity classes/Breakable.html">Breakable</a></li>
  <li><a href="../entity classes/CaptureInvItem.html">CaptureInvItem</a></li>
  <li><a href="../entity classes/CaptureItem.html">CaptureItem</a></li>
  <li><a href="../entity classes/Collectable.html">Collectable</a></li>
  <li><a href="../entity classes/CombatFX.html">CombatFX</a></li>
  <li><a href="../entity classes/Consumable.html">Consumable</a></li>
  <li><a href="../entity classes/Container.html">Container</a></li>
  <li><a href="../entity classes/Controller.html">Controller</a></li>
  <li><a href="../entity classes/Deathtrap.html">Deathtrap</a></li>
  <li><a href="../entity classes/Door.html">Door</a></li>
  <li><a href="../entity classes/EffectSpawn.html">EffectSpawn</a></li>
  <li><a href="../entity classes/Entity.html">Entity</a></li>
  <li><a href="../entity classes/Geiger.html">Geiger</a></li>
  <li><a href="../entity classes/GenericItem.html">GenericItem</a></li>
  <li><a href="../entity classes/Holodisk.html">Holodisk</a></li>
  <li><a href="../entity classes/Inventory.html">Inventory</a></li>
  <li><a href="../entity classes/Keys.html">Keys</a></li>
  <li><a href="../entity classes/Light.html">Light</a></li>
  <li><a href="../entity classes/Lockpick.html">Lockpick</a></li>
  <li><a href="../entity classes/Powernode.html">Powernode</a></li>
  <li><a href="../entity classes/Radiation.html">Radiation</a></li>
  <li><a href="../entity classes/RepairObject.html">RepairObject</a></li>
  <li><a href="../entity classes/RotatingDoor.html">RotatingDoor</a></li>
  <li><a href="../entity classes/Scenary.html">Scenary</a></li>
  <li><a href="../entity classes/ScenaryMove.html">ScenaryMove</a></li>
  <li><a href="../entity classes/ScenarySpawn.html">ScenarySpawn</a></li>
  <li><a href="../entity classes/ScienceSwitch.html">ScienceSwitch</a></li>
  <li><a href="../entity classes/SentryAI.html">SentryAI</a></li>
  <li><a href="../entity classes/SkillConsumable.html">SkillConsumable</a></li>
  <li><a href="../entity classes/Sneak.html">Sneak</a></li>
  <li><a href="../entity classes/SpawnPoint.html">SpawnPoint</a></li>
  <li><a href="../entity classes/StateBreakable.html">StateBreakable</a></li>
  <li><a href="../entity classes/StateScenary.html">StateScenary</a></li>
  <li><a href="../entity classes/Switch.html">Switch</a></li>
  <li><a href="../entity classes/Trap.html">Trap</a></li>
  <li><a href="../entity classes/TrapTrigger.html">TrapTrigger</a></li>
  <li><a href="../entity classes/Usable.html">Usable</a></li>
  <li><a href="../entity classes/Vehicle.html">Vehicle</a></li>
  <li><a href="../entity classes/VehicleController.html">VehicleController</a></li>
  <li><a href="../entity classes/VehicleWeapon.html">VehicleWeapon</a></li>
  <li><a href="../entity classes/Waypoint.html">Waypoint</a></li>
  <li><a href="../entity classes/Weapon.html">Weapon</a></li>
  <li><a href="../entity classes/WeaponMode.html">WeaponMode</a></li>
</ul>
<h2>Vtable functions</h2>
<ul class="nowrap">
  <li><a href="../vtable functions/Entity_Vtable.html">Entity_Vtable</a></li>
</ul>
<h2>Hooks</h2>
<ul class="nowrap">
  <li><a href="../hooks/Hooks.html">Hooks</a></li>
</ul>
<h2>Global Classes</h2>
<ul class="nowrap">
  <li><a href="../global classes/DefaultStyle.html">DefaultStyle</a></li>
  <li><a href="../global classes/hookexecutor.html">hookexecutor</a></li>
  <li><a href="../global classes/logger.html">logger</a></li>
  <li><a href="../global classes/world.html">world</a></li>
</ul>
<h2>Manual</h2>
<ul class="nowrap">
  <li><a href="../manual/01-introduction.md.html">Introduction</a></li>
  <li><a href="../manual/02-installation.md.html">Installation Instructions</a></li>
  <li><a href="../manual/03-patches.md.html">EXE Patches</a></li>
  <li><a href="../manual/04-scripting.md.html">LUA Scripting</a></li>
  <li><a href="../manual/05-vtables.md.html">Calling and Hooking Entity Vtable Functions</a></li>
</ul>

</div>

<div id="content">

    <h2>vtableexample.lua</h2>
<pre>
<span class="comment">--[[

This example shows how to use Entity Vtable hooks and calls to add
functionality to an item. In this case, we modify the bullhorn trap item
so that, if it is on the ground and the Science skill is used on it
(with a character at 50% or higher skill), then all traps within a 40 unit
radius are disarmed. (In practice, this is probably overpowered, and in any
event, should probably be more of a single-use item, but it's OK as an
example.)

--]]</span>

<span class="comment">-- Utility function to disarm traps within a given distance of a point.
</span><span class="comment">-- Uses Entity vtable 456 to disarm, which requires 0 parameters.
</span>
<span class="keyword">function</span> DisarmTrapsAround(center_pos,maxdist)
  <span class="keyword">local</span> ret = <span class="keyword">false</span>
  <span class="keyword">for</span> _,ent <span class="keyword">in</span> <span class="global">pairs</span>(world:GetAllEntities()) <span class="keyword">do</span>
    <span class="keyword">if</span> ent.ClassType == <span class="string">"Trap"</span> <span class="keyword">and</span> ent:IsActivated() <span class="keyword">then</span>
      <span class="keyword">local</span> entpos = ent:GetPosition()
      <span class="keyword">local</span> distx = entpos[<span class="string">"x"</span>]-center_pos[<span class="string">"x"</span>]
      <span class="keyword">local</span> disty = entpos[<span class="string">"y"</span>]-center_pos[<span class="string">"y"</span>]
      <span class="keyword">local</span> distz = entpos[<span class="string">"z"</span>]-center_pos[<span class="string">"z"</span>]
      <span class="keyword">local</span> dist = <span class="global">math</span>.sqrt(distx*distx+disty*disty+distz*distz)
      <span class="keyword">if</span> dist &lt; maxdist <span class="keyword">then</span>
        ent:CallVtable(<span class="number">456</span>)
        ret = <span class="keyword">true</span>
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="keyword">return</span> ret
<span class="keyword">end</span>

<span class="comment">--[[

Hook for Entity vtable 244 (Use skill on entity)
Parameters are:
  ent: Entity the skill is used on
  skill: String indicating which skill was used
  target1: The Actor using the skill
  target2: Empty (not set)

If the object is our desired object, then we make the skill check, and if passed,
we call DisarmTrapsAround to actually disarm the traps. If we fail the skill
check, then we use the return UseItemResponse to give an appropriate message to
the player.

If the object is not our desired object, then we call the original vtable 244
function for the entity, and use its return value as ours.

--]]</span>

<span class="keyword">function</span> Hook244(ent, skill, target1, target2)
  <span class="keyword">if</span> ent:GetName() == <span class="string">"Bull Horn Trap"</span> <span class="keyword">and</span> skill == <span class="string">"science"</span> <span class="keyword">then</span>
    <span class="keyword">if</span> target1:GetAttribute(<span class="string">"science"</span>, ACTOR_TABLE_CURRENT) &lt; <span class="number">50</span> <span class="keyword">then</span>
      <span class="keyword">local</span> ret = { status=<span class="number">1</span>, unk_entity_1 = ent, errstring=<span class="string">"trapFailWarning"</span> }
      <span class="keyword">return</span> ret
    <span class="keyword">end</span>
    <span class="keyword">local</span> ret = { status=<span class="number">0</span> }
    <span class="keyword">local</span> disarmed_one = DisarmTrapsAround(target1:GetPosition(),<span class="number">40</span>)
    <span class="keyword">if</span> disarmed_one <span class="keyword">then</span>
      world:CombatLog(COMBATLOG_SYSTEM, <span class="string">"You see some traps have been disarmed."</span>)
    <span class="keyword">end</span>
    <span class="keyword">return</span> ret
  <span class="keyword">else</span>
    <span class="keyword">return</span> ent:CallOrigVtable(<span class="number">244</span>,skill,target1,target2)
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">--[[
Hook for Entity vtable 249 (Is skill allowed on entity)
Parameters are:
  ent: Entity the skill is used on
  skill: String indicating which skill was used

We need to override this in order for Science skill to be allowed on the
bullhorn item (Science is not an allowed skill to use on traps by default). If the
item is bullhorn and skill is "science", then we return true to allow the use.
Otherwise, we return the result of calling the original 249 vtable function.
--]]</span>

<span class="keyword">function</span> Hook249(ent, skill)
  <span class="keyword">if</span> ent:GetName() == <span class="string">"Bull Horn Trap"</span> <span class="keyword">and</span> skill == <span class="string">"science"</span> <span class="keyword">then</span>
    <span class="keyword">return</span> <span class="keyword">true</span>
  <span class="keyword">end</span>
  <span class="keyword">return</span> ent:CallOrigVtable(<span class="number">249</span>,skill)
<span class="keyword">end</span>

<span class="comment">--[[
In OnStart, we use InstallVtableHook to install the new hooks for Entity vtable
244 and 249.  We only want the new function to take effect for "Trap" entity
types, as that is what the bullhorn object is.
--]]</span>

<span class="keyword">function</span> OnStart()
  hookexecutor:InstallVtableHook(<span class="string">"Trap"</span>,<span class="number">244</span>,Hook244)
  hookexecutor:InstallVtableHook(<span class="string">"Trap"</span>,<span class="number">249</span>,Hook249)
<span class="keyword">end</span></pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2024-08-15 12:18:22 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
